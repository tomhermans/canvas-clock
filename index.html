<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canvas Clock</title>
    <style>
      body {
        font-family: sans-serif;
      }
      a {
        margin: 0.5em;
        text-align: center;
      }
      a * {
        display: block;
        margin: 0.5em auto;
        text-align: center;
      }
      a canvas {
        /* background: #444; */
      }

      input {
        display: block;
        font-family: sans-serif;
        margin: 1em auto 0;
        font-size: 24px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <small>
      control look with parameters u(hours-minutes) s(size),
      c1(color1),c2(color2),fg(foreground), bg(background) || e.g.
      <a
        href="https://canvclock.netlify.app/?u=11-55&s=320&bg=#457B9D&fg=#F1FAEE&c1=#1D3557&c2=#E63946"
      >
        ?u=11-55&s=320&bg=#457B9D&fg=#F1FAEE&c1=#E63946&c2=#1D3557</a
      >
    </small>
    <input id="uur" type="time" autofocus min="00:00" max="23:59" />

    <script>
      var c = getUrlVars("u", "s");

      let size = c.s || 300;
      let color1 = c.c1 || "#000";
      let color2 = c.c2 || "#f00";
      let bg = c.bg || "#000";
      let plate = c.fg || "#fff";

      // don't touch
      console.log(bg, color2, color1);

      function makeCanvas(h, m) {
        var canvas = document.createElement("canvas");
        canvas.setAttribute("id", "canvas");
        canvas.setAttribute("width", size);
        canvas.setAttribute("height", size);
        // var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        var radius = canvas.height / 2;
        ctx.translate(radius, radius);
        radius = radius * 0.9;
        drawClock(ctx, radius, h, m);

        var dl = canvas.toDataURL("image/jpeg", 0.7); // mime + quality
        var dllink = document.createElement("a");
        // randomize filename
        var d = new Date();
        var n = d.getTime();
        var filename = "mijnklok_" + n;
        dllink.href = dl;
        dllink.id = "dl";
        var dltext = document.createElement("span");
        dltext.innerHTML = "click to download";
        dllink.setAttribute("download", filename);
        dllink.appendChild(dltext);
        dllink.appendChild(canvas);
        document.body.appendChild(dllink);
      }

      function drawClock(ctx, radius, h, m) {
        ctx.arc(0, 0, radius, 0, 2 * Math.PI);
        ctx.fillStyle = plate;
        ctx.fill();
        ctx.closePath();
        ctx.beginPath();

        drawNumbers(ctx, radius);
        drawTime(ctx, radius, h, m, 0);

        ctx.fillStyle = color2;
        ctx.arc(0, 0, 8, 0, Math.PI * 2, true);
        ctx.fill();
        ctx.closePath();
      }
      function drawNumbers(ctx, radius) {
        var ang;
        var num;
        ctx.font = radius * 0.15 + "px arial";
        ctx.fillStyle = "black";
        ctx.textBaseline = "middle";
        ctx.textAlign = "center";
        for (num = 1; num < 13; num++) {
          ang = (num * Math.PI) / 6;
          ctx.rotate(ang);
          ctx.translate(0, -radius * 0.85);
          ctx.rotate(-ang);
          ctx.fillText(num.toString(), 0, 0);
          ctx.rotate(ang);
          ctx.translate(0, radius * 0.85);
          ctx.rotate(-ang);
        }
      }
      function drawTime(ctx, radius, h, m, s) {
        if (h) {
          var hour = h;
          var minute = m;
          var second = s;
          // console.log("drawing - set hour", h, m, s);
        } else {
          var now = new Date();
          var hour = now.getHours();
          var minute = now.getMinutes();
          var second = now.getSeconds();
        }
        // console.log(hour, minute, second);
        //hour
        hour = hour % 12;
        hour =
          (hour * Math.PI) / 6 +
          (minute * Math.PI) / (6 * 60) +
          (second * Math.PI) / (360 * 60);
        drawHand(ctx, hour, radius * 0.5, radius * 0.04, color1);
        //minute
        minute = (minute * Math.PI) / 30 + (second * Math.PI) / (30 * 60);
        drawHand(ctx, minute, radius * 0.7, radius * 0.02, color2);
        // second
        second = (second * Math.PI) / 30;
        // drawHand(ctx, second, radius*0.9, radius*0.02,  '#000'); // no seconds
      }
      function drawHand(ctx, pos, length, width, color) {
        ctx.beginPath();
        ctx.lineWidth = width;
        ctx.strokeStyle = color;
        ctx.lineCap = "round";
        ctx.moveTo(0, 0);
        ctx.rotate(pos);
        ctx.lineTo(0, -length);
        ctx.stroke();
        ctx.rotate(-pos);
        ctx.closePath();
      }

      if (isEmpty(c)) {
        makeCanvas();
      } else {
        var u = c.u;
        var h = c.u.split("-")[0];
        var m = c.u.split("-")[1];
        // console.log("h en m ", h, m);
        makeCanvas(h, m);
      }

      let uur = document.getElementById("uur");
      uur.addEventListener("change", (e) => {
        e.preventDefault();
        // console.log("uur", e.target.value);
        var setTime = e.target.value.split(":");
        // console.log(setTime[0], setTime[1]);
        var dl = document.getElementById("dl");
        dl.remove();
        makeCanvas(setTime[0], setTime[1]);
      });

      function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(
          /[?&]+([^=&]+)=([^&]*)/gi,
          function (m, key, value) {
            vars[key] = value;
          }
        );
        // console.log({ vars });
        return vars;
      }
      function isEmpty(obj) {
        return Object.keys(obj).length === 0;
      }
    </script>
  </body>
</html>
